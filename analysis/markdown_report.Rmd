---
title: "Lipids Audit"
author: "Rob Willans"
date: "15/03/2022"
output: 
  html_document:
    toc: true
    toc_float: true
---

```{r setup, include=FALSE}
library(tidyverse)
library(janitor)

knitr::opts_chunk$set(echo = TRUE)


## Load data from cohort extractor
df_input <- read_csv(here::here("output", "input.csv")) %>%
  mutate(
    "age_group" = case_when(
      age < 40 ~ "18-39",
      age < 60 ~ "40-59",
      age < 80 ~ "60-79",
      age >= 80 ~ "80-84",
      TRUE ~ "No age"
    ),
    "CVD_assess_cat" = case_when(
      is.na(CVD_assess_latest_number) ~ "No CVD Risk Assessment Noted",
      TRUE ~ "CVD Risk Assessment"
    ),
    "statin_cat" = case_when(
      is.na(statins_prescribed) ~ "No Statin Recorded",
      TRUE ~ "Statins Recorded"
    )
  )
  

summarise_df_by_group <- function(df, ...){
  df %>% 
    group_by(...) %>% 
    summarise(n=n(),
              percentage = n / nrow(.)*100, .groups = "keep") %>% 
    ungroup()
}

```

# Initial counts

## Total N

```{r}

nrow(df_input)

```

## N with CVD diagnosis prior to 2022-01-01 (aged 18-84 at 2022-01-01)

```{r CVD_n}

df_input %>%
  filter(CVD_code == 1) %>% 
  summarise_df_by_group(age_group)

```

## N with CKD diagnosis prior to 2022-01-01 (aged 18-84 at 2022-01-01)

```{r CKD_n}

df_input %>%
  filter(CKD_code == 1) %>% 
  summarise_df_by_group(age_group)

```

## N with T1D diagnosis prior to 2022-01-01 (aged 18-84 at 2022-01-01)

```{r T1D_n}

df_input %>%
  filter(T1D_code == 1) %>% 
  summarise_df_by_group(age_group)

```

## N with T2D diagnosis prior to 2022-01-01 (aged 18-84 at 2022-01-01)

```{r T2D_n}

df_input %>%
  filter(T2D_code == 1) %>% 
  summarise_df_by_group(age_group)

```

## N with any DM diagnosis prior to 2022-01-01 (aged 18-84 at 2022-01-01)

```{r anyDcode_n}

df_input %>%
  filter(Overall_diab_code == 1) %>% 
  summarise_df_by_group(age_group)

```

## N excluding CVD, CKD, T1D (aged 40-84 at 2022-01-01)


```{r noCVDCKDT1D}

df_input %>% 
  filter(age >= 40,
         CVD_code == 0,
         CKD_code == 0, 
         T1D_code == 0) %>% 
  nrow()

```

## N excluding CVD, CKD, T1D and risk assessment more than 5 years ago (aged 40-84 at 2022-01-01)

```{r excluderiskassessmorethanfiveyears}

df_input %>% 
  filter(age >= 40,
         CVD_code == 0,
         CKD_code == 0, 
         T1D_code == 0,
         CVD_assess_latest_date >= "2017-01-01") %>% 
  nrow()


```


# Calculations

## Calculate % patients with CVD assessment in past 5 years

```{r addCVDriskcat}

df_input %>% 
  summarise_df_by_group(sex, age_group, CVD_assess_cat)
         
```

## Calculate % patients (by sex and age group) with prior CVD diag (on or before 2022-01-01) and statin prescription (on or before 2022-01-01)

```{r CVD }

df_input %>% 
  filter(CVD_code == 1) %>% 
  summarise_df_by_group(sex, age_group, statin_cat) 

```
## Calculate % patients (total) with prior CVD diag (on or before 2022-01-01) and statin prescription (on or before 2022-01-01)

```{r CVDtotal}

df_input %>% 
  filter(CVD_code == 1) %>% 
  summarise_df_by_group(statin_cat) 

```

## Calculate % patients (by sex and age group) with CVD risk over 10 with statin prescription

```{r CVDgreaterthan10statins}

df_input %>% 
  filter(CVD_assess_latest_number >= 10) %>% 
  summarise_df_by_group(sex, age_group, statin_cat) 


```

## Calculate % patients (by sex and age group) with CVD risk over 20 with statin prescription

```{r CVDgreaterthan20statins}

df_input %>% 
  filter(CVD_assess_latest_number >= 20) %>% 
  summarise_df_by_group(sex, age_group, statin_cat) 

```

## calculate % patients with CKD on statins (split sex and age group)

```{r preexistCKDgtatins}

df_input %>% 
  filter(CKD_code == 1) %>% 
  summarise_df_by_group(sex, age_group, statin_cat) 


```


## calculate % patients with CKD on statins (total)

```{r preexistCKDstatinstotal}
df_input %>% 
  filter(CKD_code == 1) %>% 
  summarise_df_by_group(statin_cat) 

```