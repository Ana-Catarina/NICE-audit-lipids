---
title: "Lipids Audit"
author: "Rob Willans"
date: "15/03/2022"
output: 
  html_document:
    toc: true
    toc_float: true
---

```{r setup, include=FALSE}
library(tidyverse)
library(janitor)

knitr::opts_chunk$set(echo = TRUE)


## Load data from cohort extractor
df_input <- read_csv(here::here("output", "input.csv")) %>%
  mutate(
    "age_group" = case_when(
      age < 40 ~ "18-39",
      age < 60 ~ "40-59",
      age < 80 ~ "60-79",
      age >= 80 ~ "80-84",
      TRUE ~ "No age"
    ),
    "CVD_assess_cat" = case_when(
      CVD_assess_latest_number > 0 ~ "CVD Risk Assessment",
      (is.na(CVD_assess_latest_number)|CVD_assess_latest_number == 0) ~ "No CVD Risk Assessment Noted",
      TRUE ~ "Rule Failure"
    ),
    "statin_cat" = case_when(
      is.na(statins_issued) ~ "No Statin Recorded",
      TRUE ~ "Statins Recorded"
    ),
    "cvd_statin_cat" = case_when(
      is.na(cvdprevent_statins_issued) ~ "No Statin Recorded (CVDPREVENT)",
      TRUE ~ "Statins Recorded (CVDPREVENT)"
    ),
    "cvd_statin_cat_last_6m" = case_when(
      is.na(cvdprevent_statins_issued_last_6m) ~ "No statin Recorded in last 6m (CVDPREVENT)",
      TRUE ~ "Statins Recorded in last 6m (CVDPREVENT)"
    ),
  )
  

summarise_df_by_group <- function(df, ...){
  df %>% 
    group_by(...) %>% 
    summarise(n=n()) %>% 
    ungroup() %>% 
    mutate("percentage" = n/sum(n)*100) %>%
    adorn_totals()
  }

```

# Initial counts

## Total N (aged 18-84 inclusive at end of 2021)

```{r}

nrow(df_input)

```



## N with CVD diagnosis 

* CVD codelist taken from CVDPrevent definitions, including stroke codes,  TIA codes, CHD codes, PAD codes and excluding HF and AAA codes

```{r CVD_n}

df_input %>%
  filter(CVD_code_CVD_prevent == 1) %>% 
  summarise_df_by_group(age_group)

```

## N with CKD diagnosis 

```{r CKD_n}

df_input %>%
  filter(CKD_code == 1) %>% 
  summarise_df_by_group(age_group)

```

## N with T1D diagnosis

```{r T1D_n}

df_input %>%
  filter(T1D_code == 1) %>% 
  summarise_df_by_group(age_group)

```

## N with T2D diagnosis

```{r T2D_n}

df_input %>%
  filter(T2D_code == 1) %>% 
  summarise_df_by_group(age_group)

```

## N with any DM diagnosis

```{r anyDcode_n}

df_input %>%
  filter(Overall_diab_code == 1) %>% 
  summarise_df_by_group(age_group)

```
## N total statin prescriptions

```{r totalstatins}

df_input %>% 
  summarise_df_by_group(statin_cat)

```

## N total statin prescriptions (CVDPREVENT statin list)

```{r totalstatinscvdp}

df_input %>% 
  summarise_df_by_group(cvd_statin_cat)

```
## N excluding CVD, CKD, T1D (aged 40-84 at 2022-01-01)

```{r noCVDCKDT1D}

df_input %>% 
  filter(age >= 40,
         CVD_code_CVD_prevent == 0,
         CKD_code == 0, 
         T1D_code == 0) %>% 
  nrow()

```
## N excluding CVD, CKD, T1D and risk assessment more than 5 years ago [Indicator 1]

•	How many people aged 40-84y (excluding pre-existing CVD, T1DM and CKD) have had a CVD risk assessment recorded in the preceding 5 years?

```{r excluderiskassessmorethanfiveyears}

df_input %>% 
  filter(age >= 40,
         CVD_code_CVD_prevent == 0,
         CKD_code == 0, 
         T1D_code == 0,
         CVD_assess_latest_date >= "2016-12-31") %>% 
  nrow()

```
## Histograms of CVD risk assesment values

```{r cvdriskhistogram}

options(scipen = 999)

df_input %>% 
  filter(between(CVD_assess_latest_number, 0.0000001, 1)) %>% 
  ggplot(aes(x = CVD_assess_latest_number)) + 
  geom_histogram()

df_input %>% 
  filter(between(CVD_assess_latest_number, 1, 100)) %>% 
  ggplot(aes(x = CVD_assess_latest_number)) + 
  geom_histogram()

```
## N with no cvd_assess_number

```{r nocvdassess}

nrow(df_input %>% filter(CVD_assess_latest_number == 0))

```

## N with cvd_assess_number missing

```{r nocvdassess}

nrow(df_input %>% filter(is.na(CVD_assess_latest_number)))

```

# Calculations

## Calculate % patients with CVD assessment at any time prior to 31st Dec 2021

```{r addCVDriskcat}

df_input %>% 
  summarise_df_by_group(sex, age_group, CVD_assess_cat)
         
```

## Calculate % patients (by age group) with CVD risk over 10 with statin prescription in last 6 months

3.	How many people with a recorded CVD risk assessment score of ≥ 10% are currently treated with a lipid modifying therapy. 

```{r CVDgreaterthan10statins}

df_input %>% 
  filter(CVD_assess_latest_number >= 0.1,
         CVD_code_CVD_prevent == 0,
         CKD_code == 0, 
         ) %>% 
  summarise_df_by_group(age_group, cvd_statin_cat_last_6m) 


```
## Calculate % patients with CVD risk over 20 with statin prescription

4.	How many people with a recorded CVD risk assessment score of ≥ 20% are currently treated with a lipid modifying therapy. 

```{r CVDgreaterthan20statinsalt}

df_input %>% 
  filter(CVD_assess_latest_number >= 0.2,
         CVD_code_CVD_prevent == 0,
         CKD_code == 0) %>% 
  summarise_df_by_group(age_group, cvd_statin_cat_last_6m) 

```

## Calculate % patients with prexisting CVD/CKD currently treated with lipid modifying therapy.

```{r CVDCKDstatins}

df_input %>% 
  filter(
         CVD_code_CVD_prevent == 1,
         CKD_code == 1
         ) %>% 
  summarise_df_by_group(age_group, cvd_statin_cat_last_6m) 

```




